-- ============================================================
-- CODEHERO MASTER INSTALLATION SCRIPT
-- ============================================================
-- Usage: Run this entire script in the Supabase SQL Editor.
-- This sets up the complete database schema, security policies,
-- and admin functions required for the application.

-- 1. ENABLE ROW LEVEL SECURITY (Base)
alter table auth.users enable row level security;

-- 2. PUBLIC TABLES

-- PROFILES
create table if not exists public.profiles (
  id uuid references auth.users not null primary key,
  username text unique,
  email text, -- Added for Admin Panel management
  avatar_svg text,
  role text default 'user' check (role in ('user', 'admin')),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- WORLDS
create table if not exists public.worlds (
  id bigint generated by default as identity primary key,
  title text not null,
  description text,
  style text, -- 'cyberpunk', 'matrix', etc
  level_range int[] -- e.g. {1, 10}
);
alter table public.worlds enable row level security;
create policy "Worlds are public." on worlds for select using (true);
create policy "Admins can edit worlds." on worlds for all using (
  exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
);

-- PHASES
create table if not exists public.phases (
  id bigint generated by default as identity primary key,
  world_id bigint references public.worlds not null,
  title text not null,
  description text,
  order_index int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now())
);
alter table public.phases enable row level security;
create policy "Phases are public." on phases for select using (true);
create policy "Admins can edit phases." on phases for all using (
  exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
);

-- LEVELS
create table if not exists public.levels (
  id bigint generated by default as identity primary key,
  phase_id bigint references public.phases not null,
  title text not null,
  type text,
  description text,
  map jsonb,
  start_pos jsonb,
  end_pos jsonb,
  perfect_score int,
  hint text,
  start_code jsonb default '[]'::jsonb, -- New: For debugging levels
  created_at timestamp with time zone default timezone('utc'::text, now())
);
alter table public.levels enable row level security;
drop policy if exists "Levels are public." on levels;
drop policy if exists "Admins can edit levels." on levels;

create policy "Levels are public." on levels for select using (true);
create policy "Admins can edit levels." on levels for all using (
  exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
);

-- ... (Existing Policies) ...

-- UPDATE USER EMAIL ADMIN
-- Drops existing to ensure return type compatibility if signature changes
DROP FUNCTION IF EXISTS public.update_user_email_admin(uuid, text);

CREATE OR REPLACE FUNCTION public.update_user_email_admin(target_user_id uuid, new_email text)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Security Check
  IF NOT EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin') THEN
    RAISE EXCEPTION 'Access Denied';
  END IF;

  -- Update Auth (Handles login)
  UPDATE auth.users 
  SET email = new_email, 
      email_confirmed_at = now(),
      updated_at = now() 
  WHERE id = target_user_id;

  -- Update Profile
  UPDATE public.profiles 
  SET email = new_email 
  WHERE id = target_user_id;
END;
$$;

-- Grant permissions for RPCs
grant execute on function public.delete_user_admin to authenticated;
grant execute on function public.update_user_email_admin to authenticated;

-- 4. CLEANUP LEGACY TRIGGERS
-- Ensure the flashing/race-condition causing trigger is gone
drop trigger if exists on_auth_user_created on auth.users;
drop function if exists public.handle_new_user();

-- 5. CONTENT MANAGEMENT (SEED & RESTORE)

-- FUNCTION: RESET LEVEL DATA
-- Allows Admins to restore the original 14 Levels, Worlds, and Phases.
create or replace function public.reset_level_data()
returns void
language plpgsql
security definer
as $$
DECLARE
    p_seq_id bigint;
    p_ori_id bigint;
    p_loop_id bigint;
    p_cond_id bigint;
    p_debug_id bigint;
BEGIN
    -- 1. Security Check
    if not exists (select 1 from public.profiles where id = auth.uid() and role = 'admin') then
        raise exception 'Access Denied';
    end if;

    -- HARD RESET: Clear Tables to ensure clean IDs and relationships
    DELETE FROM public.progress; -- Removed first to satisfy FK constraints
    DELETE FROM public.levels;
    DELETE FROM public.phases;
    DELETE FROM public.worlds;

    -- 0. FIX SEQUENCES (Reset to 1 since tables are empty)
    ALTER SEQUENCE public.worlds_id_seq RESTART WITH 1;
    ALTER SEQUENCE public.phases_id_seq RESTART WITH 1;
    ALTER SEQUENCE public.levels_id_seq RESTART WITH 1;

    -- 2. RESTORE WORLDS
    insert into public.worlds (id, title, description, style, level_range)
    overriding system value
    values (1, 'Mundo 1: L贸gica & Algoritmos', 'Aprende los fundamentos de la programaci贸n.', 'cyberpunk', '{0,13}')
    on conflict (id) do update set 
        title = EXCLUDED.title,
        description = EXCLUDED.description;

    insert into public.worlds (id, title, description, style, level_range)
    overriding system value
    values (2, 'Mundo 2: La Base de Datos', 'Niveles avanzados de reparaci贸n y optimizaci贸n.', 'matrix', '{14,20}')
    on conflict (id) do update set title = EXCLUDED.title;

    -- 3. RESTORE PHASES
    -- Since we cleared table, we can just insert directly.
    INSERT INTO phases (id, world_id, title, description, order_index) VALUES 
        (1, 1, 'Secuenciaci贸n', 'Pasos b谩sicos y orden.', 1),
        (2, 1, 'Orientaci贸n', 'Giros y movimiento espacial.', 2),
        (3, 1, 'Bucles & Patron', 'Repetici贸n eficiente.', 3),
        (4, 1, 'Estado (Llaves)', 'Condicionales y memoria.', 4),
        (5, 1, 'L贸gica Avanzada', 'Portales y retos complejos.', 5),
        (6, 2, 'Reparaci贸n (Debugging)', 'El c贸digo est谩 roto. 隆Encuentra el error y arr茅glalo!', 1);

    -- Sync Phase Sequence after manual ID insertion
    PERFORM setval('public.phases_id_seq', (SELECT MAX(id) FROM public.phases));
    
    -- IDs for Level Insertion (Now we know them explicitly)
    p_seq_id := 1;
    p_ori_id := 2;
    p_loop_id := 3;
    p_cond_id := 4;
    p_adv_id := 5;
    p_debug_id := 6;



    -- 4. RESTORE LEVELS
    -- We can match by TITLE to update, since IDs might be auto-gen if we didn't force them.
    -- But earlier we wanted to force IDs for Levels? The previous script didn't force IDs for levels.
    -- Let's Update based on Title for now, or Delete and Recreate (but that breaks progress).
    -- BEST: Update based on Title.
    
    -- Function to upsert level by title
    -- Phase 1
    PERFORM upsert_level_by_title(p_seq_id, 'El Primer Paso', 'Tutorial', 'Un algoritmo es una lista de pasos. Diles a tu robot que avance dos veces para llegar a la meta .', '[[1, 1, 1, 1, 1], [1, 0, 0, 0, 1], [1, 2, 0, 0, 1], [1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":3,"y":1}', 2, '[]');
    PERFORM upsert_level_by_title(p_seq_id, 'La Ruta Exacta', 'B谩sico', 'La precisi贸n es clave. Cuenta las casillas: si das pasos de m谩s, chocar谩s.', '[[1, 1, 1, 1, 1, 1, 1], [1, 0, 0, 0, 0, 0, 1], [1, 1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":5,"y":1}', 4, '[]');

    -- Phase 2
    PERFORM upsert_level_by_title(p_ori_id, 'El Giro', 'Giros', 'Girar cambia tu direcci贸n, pero no te mueve. Gira y luego avanza.', '[[1, 1, 1, 1, 1], [1, 1, 0, 0, 1], [1, 0, 0, 1, 1], [1, 1, 1, 1, 1]]', '{"x":1,"y":2,"dir":1}', '{"x":3,"y":1}', 5, '[]');
    PERFORM upsert_level_by_title(p_ori_id, 'La Serpiente', 'Giros', 'Combina giros y pasos. Izquierda, derecha... 隆No te marees!', '[[1, 1, 1, 1, 1], [1, 0, 0, 0, 1], [1, 1, 1, 0, 1], [1, 0, 0, 0, 1], [1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":1,"y":3}', 8, '[]');
    PERFORM upsert_level_by_title(p_ori_id, 'Media Vuelta', 'Giros', 'Te has metido en un callej贸n sin salida. Da media vuelta (gira dos veces) para salir.', '[[1, 1, 1, 1, 1], [0, 0, 0, 0, 1], [1, 1, 1, 1, 1]]', '{"x":3,"y":1,"dir":2}', '{"x":0,"y":1}', 5, '[]');

    -- Phase 3
    PERFORM upsert_level_by_title(p_loop_id, 'Trabajo Manual', 'Patrones', '驴Notas que repites lo mismo? Avanzar, Girar, Avanzar, Girar... Hazlo paso a paso esta vez.', '[[1, 1, 1, 1, 1, 1], [1, 1, 1, 0, 0, 1], [1, 1, 0, 0, 1, 1], [1, 0, 0, 1, 1, 1], [1, 1, 1, 1, 1, 1]]', '{"x":1,"y":3,"dir":1}', '{"x":4,"y":1}', 9, '[]');
    PERFORM upsert_level_by_title(p_loop_id, 'Automatizaci贸n', 'Bucles', '隆Ahora usa el bot贸n BUCLE ! Escribe el patr贸n UNA vez y rep铆telo 3 veces.', '[[1, 1, 1, 1, 1, 1], [1, 1, 1, 0, 0, 1], [1, 1, 0, 0, 1, 1], [1, 0, 0, 1, 1, 1], [1, 1, 1, 1, 1, 1]]', '{"x":1,"y":3,"dir":1}', '{"x":4,"y":1}', 6, '[]');
    PERFORM upsert_level_by_title(p_loop_id, 'El Corredor Infinito', 'Bucles', '8 pasos son muchos bloques... Usa un bucle para caminar todo el pasillo con una sola orden.', '[[1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 0, 0, 0, 0, 0, 0, 0, 0, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":8,"y":1}', 2, '[]');

    -- Phase 4
    PERFORM upsert_level_by_title(p_cond_id, 'La Puerta Cerrada', 'Condicionales', 'El camino est谩 bloqueado . La llave  cambia las reglas: t贸mala para poder pasar.', '[[1, 1, 1, 1, 1, 1, 1], [1, 0, 2, 0, 3, 0, 1], [1, 1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":5,"y":1}', 5, '[]');
    PERFORM upsert_level_by_title(p_cond_id, 'El Recado', 'Condicionales', 'Divide el problema: 1. Ve por la llave. 2. Regresa a la puerta.', '[[1, 1, 1, 1, 1, 1, 1], [1, 3, 0, 0, 0, 2, 1], [1, 1, 1, 1, 1, 1, 1]]', '{"x":2,"y":1,"dir":1}', '{"x":0,"y":1}', 10, '[]');

    -- Phase 5
    PERFORM upsert_level_by_title(p_adv_id, 'Teletransporte', 'Portales', 'Los caminos no siempre son rectos. Entra al portal  para saltar los muros.', '[[1, 1, 1, 1, 1, 1], [1, 0, 4, 1, 4, 1], [1, 0, 1, 1, 0, 1], [1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":4,"y":2}', 3, '[]');
    PERFORM upsert_level_by_title(p_adv_id, 'El Laberinto Roto', 'Debugging', 'Un camino est谩 roto. Analiza el mapa antes de programar y encuentra la ruta segura.', '[[1, 1, 1, 1, 1, 1, 1], [1, 0, 0, 1, 0, 0, 1], [1, 0, 1, 1, 1, 0, 1], [1, 0, 0, 0, 0, 0, 1], [1, 1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":2}', '{"x":5,"y":1}', 12, '[]');
    PERFORM upsert_level_by_title(p_adv_id, 'Reuniendo Conceptos', 'Avanzado', 'Bucles y Portales. Usa el bucle para llegar al portal r谩pidamente.', '[[1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 0, 0, 0, 0, 4, 1, 4, 1], [1, 1, 1, 1, 1, 1, 1, 0, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":7,"y":2}', 5, '[]');
    PERFORM upsert_level_by_title(p_adv_id, 'El Algoritmo Maestro', 'Boss', 'EXAMEN FINAL: Llave, Puerta y Portales. 隆Demuestra que eres un Code Hero!', '[[1, 1, 1, 1, 1, 1, 1], [1, 0, 2, 1, 0, 0, 1], [1, 0, 1, 1, 1, 3, 1], [1, 4, 0, 0, 0, 4, 1], [1, 1, 1, 1, 1, 1, 1]]', '{"x":1,"y":1,"dir":1}', '{"x":5,"y":1}', 15);

    -- Level 1: Infinite Loop Bug
    PERFORM upsert_level_by_title(p_debug_id, 'El Bucle Infinito', 'Debugging', 
        'BUG DETECTADO: El bucle se repite demasiadas veces y choca. Ajusta el contador.', 
        '[[1,1,1,1,1,1,1],[1,0,0,0,0,1,1],[1,1,1,1,1,1,1]]', 
        '{"x":1,"y":1,"dir":1}', '{"x":4,"y":1}', 2,
        '[{"type":"loop","count":10,"cmds":["moveForward"]}]'::jsonb
    );

    -- Level 2: The Forgotten Step (Off by One)
    PERFORM upsert_level_by_title(p_debug_id, 'El Paso Olvidado', 'Debugging', 
        'BUG DETECTADO: El robot se queda corto. Le falta una instrucci贸n final.', 
        '[[1,1,1,1,1,1],[1,0,0,0,0,1],[1,1,1,1,1,1]]', 
        '{"x":1,"y":1,"dir":1}', '{"x":4,"y":1}', 4,
        '["moveForward","moveForward"]'::jsonb
    );

    -- Level 3: Wrong Turn (Logic Error)
    PERFORM upsert_level_by_title(p_debug_id, 'Giro Incorrecto', 'Debugging', 
        'BUG DETECTADO: El robot gira a la izquierda, pero el camino es a la derecha.', 
        '[[1,1,1,1,1,1],[1,0,0,1,1,1],[1,1,0,0,0,1],[1,1,1,1,1,1]]', 
        '{"x":1,"y":1,"dir":1}', '{"x":4,"y":2}', 5,
        '["moveForward","moveForward","turnLeft","moveForward","moveForward"]'::jsonb
    );

    -- Level 4: Optimization (Spaghetti Code)
    PERFORM upsert_level_by_title(p_debug_id, 'C贸digo Espagueti', 'Refactor', 
        'OPTIMIZACIN: Este c贸digo funciona, pero es muy largo y desordenado. Usa un Bucle para limpiarlo.', 
        '[[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]', 
        '{"x":1,"y":1,"dir":1}', '{"x":6,"y":1}', 2,
        '["moveForward","moveForward","moveForward","moveForward","moveForward"]'::jsonb
    );

    -- Level 5: Security Breach (Missing Key)
    PERFORM upsert_level_by_title(p_debug_id, 'Acceso Denegado', 'Debugging', 
        'ERROR DE SEGURIDAD: Intentando abrir la puerta sin la llave. Modifica la ruta para recoger la llave primero.', 
        '[[1,1,1,1,1,1],[1,2,0,1,3,1],[1,0,0,0,0,1],[1,1,1,1,1,1]]', 
        '{"x":2,"y":2,"dir":1}', '{"x":5,"y":1}', 7,
        '["moveForward","moveForward","turnLeft","moveForward"]'::jsonb
    );

END;
$$;

-- HELPER PROCEDURE (To make upserts cleaner above)
create or replace function public.upsert_level_by_title(
    p_phase_id bigint, p_title text, p_type text, p_desc text, p_map jsonb, p_start jsonb, p_end jsonb, p_perfect int, p_start_code jsonb default '[]'::jsonb
) returns void language plpgsql as $$
BEGIN
    if exists (select 1 from levels where title = p_title) then
        update levels set 
            phase_id = p_phase_id, type = p_type, description = p_desc, map = p_map, 
            start_pos = p_start, end_pos = p_end, perfect_score = p_perfect, start_code = p_start_code
        where title = p_title;
    else
        insert into levels (phase_id, title, type, description, map, start_pos, end_pos, perfect_score, start_code)
        values (p_phase_id, p_title, p_type, p_desc, p_map, p_start, p_end, p_perfect, p_start_code);
    end if;
END;
$$;

-- Grant permissions
grant execute on function public.reset_level_data to authenticated;
grant execute on function public.upsert_level_by_title to authenticated;

-- Run it immediately for the install
select public.reset_level_data();  

SELECT 'CodeHero Database Installed & Seeded Successfully' as status;
